apiVersion: "cilium.io/v2"
kind: "CiliumNetworkPolicy"
metadata:
  name: "cert-manager-internal-network-policy"
  namespace: "cert-manager"
spec:
  endpointSelector:
    matchLabels:
      app.kubernetes.io/instance: cert-manager
      app.kubernetes.io/name: cert-manager
  
  # Ingress section (omitted for brevity, as it was not the source of the error)

  egress:
    # 1. & 7. UDP / TCP: cert-manager (all) -> Kubernetes DNS / External DNS
    # ðŸŒŸ FIX: Updated matchLabels to k8s-app: kube-dns
    - toEndpoints:
      - matchLabels:
          # This selector now correctly targets the CoreDNS pods
          k8s-app: kube-dns 
      toPorts:
      - ports:
        - port: "53"
          protocol: UDP
        - port: "53"
          protocol: TCP

    # 3. TCP: cert-manager (webhook, controller, cainjector, startupapicheck) -> Kubernetes API server
    # Allows components to connect to the K8s API.
    - toEndpoints:
      - matchLabels:
          k8s: kube-apiserver # This label might need adjustment based on your specific K8s environment
      toPorts:
      - ports:
        - port: "6443" # Common API server port
          protocol: TCP
        - port: "443" # Alternative common API server port
          protocol: TCP
      
    # External FQDN Egress (Required for ACME communication)
    # The cert-manager controller needs to be able to talk to Let's Encrypt
    - toFQDNs:
      - matchName: "acme-v02.api.letsencrypt.org"
      toPorts:
      - ports:
        - port: "443"
          protocol: TCP
    
    # Optional FQDN Egress (to handle potential redirects)
    - toFQDNs:
      - matchName: "api.letsencrypt.org"
      toPorts:
      - ports:
        - port: "443"
          protocol: TCP