#!/bin/bash
set -e  # exit immediately on error

# -------------------------------
# Load environment variables
# -------------------------------
# Source main env file
if [ -f ../.cloud-proxy.dev.env ]; then
    source ../.cloud-proxy.dev.env
else
    echo "ERROR: ../.cloud-proxy.dev.env not found!"
    exit 1
fi

echo "Creating EC2 Instance $INSTANCE_NAME in AWS"

# -------------------------------
# Get secrets from RKE2 cluster
# -------------------------------
echo "Getting environment variables from RKE2 cluster..."
CILIUM_CA=$(kubectl get secret -n kube-system cilium-ca -o yaml)
TOKEN=$(sudo cat /var/lib/rancher/rke2/server/node-token)

# -------------------------------
# Update AWS Secrets Manager (optional)
# -------------------------------
# Uncomment and adjust if needed
# aws secretsmanager create-secret --name public-key --secret-string file://"$PUBLIC_KEY" 2>/dev/null || \
# aws secretsmanager put-secret-value --secret-id public-key --secret-string file://"$PUBLIC_KEY"
#
# aws secretsmanager create-secret --name cilium-certificate --secret-string "$CILIUM_CA" 2>/dev/null || \
# aws secretsmanager put-secret-value --secret-id cilium-certificate --secret-string "$CILIUM_CA"
#
# aws secretsmanager create-secret --name on-site-token --secret-string "$TOKEN" 2>/dev/null || \
# aws secretsmanager put-secret-value --secret-id on-site-token --secret-string "$TOKEN"

# -------------------------------
# Terminate existing instance(s)
# -------------------------------
echo "Checking if EC2 instance exists..."
INSTANCE_IDS=$(aws ec2 describe-instances \
    --filters "Name=tag:Name,Values=$INSTANCE_NAME" "Name=instance-state-name,Values=pending,running,stopping,stopped" \
    --query "Reservations[*].Instances[*].InstanceId" --output text)

if [ -n "$INSTANCE_IDS" ]; then
    echo "Instance(s) found: $INSTANCE_IDS"
    echo "Terminating..."
    aws ec2 terminate-instances --instance-ids $INSTANCE_IDS
    aws ec2 wait instance-terminated --instance-ids $INSTANCE_IDS
    echo "Instance(s) terminated."
else
    echo "No instance found with Name=$INSTANCE_NAME"
fi

# -------------------------------
# Create new EC2 instance
# -------------------------------
echo "Creating EC2 instance $INSTANCE_NAME..."

# Handle user-data if it is a URL
if [[ "$STARTUP_SCRIPT_URL" =~ ^https?:// ]]; then
    USER_DATA=$(curl -s "$STARTUP_SCRIPT_URL")
else
    USER_DATA="$STARTUP_SCRIPT_URL"
fi

INSTANCE_ID=$(aws ec2 run-instances \
    --image-id "ami-0f5fcdfbd140e4ab7" \
    --count 1 \
    --instance-type "$INSTANCE_TYPE" \
    --key-name "$KEY_NAME" \
    --subnet-id "$SUBNET_ID" \
    --associate-public-ip-address \
    --security-group-ids "$SECURITY_GROUP_IDS" \
    --tag-specifications "ResourceType=instance,Tags=[{Key=Name,Value=$INSTANCE_NAME}]" \
    --user-data "$STARTUP_SCRIPT_URL" \
    --query 'Instances[0].InstanceId' \
    --output text)

echo "Waiting for instance to be running..."
aws ec2 wait instance-running --instance-ids "$INSTANCE_ID"

# Get the public DNS
PUBLIC_DNS=$(aws ec2 describe-instances \
    --instance-ids "$INSTANCE_ID" \
    --query 'Reservations[0].Instances[0].PublicDnsName' \
    --output text)

echo "Instance is running at $PUBLIC_DNS"

# -------------------------------
# SSH into the instance
# -------------------------------
SSH_RETRIES=4
SSH_DELAY=10

for ((i=1;i<=SSH_RETRIES;i++)); do
    echo "Attempt $i to SSH into $PUBLIC_DNS..."
    ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 ubuntu@"$PUBLIC_DNS" && break
    echo "SSH failed, retrying in $SSH_DELAY seconds..."
    sleep $SSH_DELAY
done

echo "Script completed successfully."
